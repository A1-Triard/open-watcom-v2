language: c

compiler: clang

env:
  global:
    - OWROOT=$TRAVIS_BUILD_DIR
    - OWTOOLS=CLANG
    - OWOBJDIR=binbuild
    - OWDOCBUILD=0
    - OWDOCQUIET=1
    - USE_FILENAME_VERSION=1

sudo: false

addons:
  apt:
    packages:
      # install DOS Emulator
      - dosemu
      # install Ghostscript
      - ghostscript

cache:
  directories:
    - ${TRAVIS_BUILD_DIR}/build/bin

before_script:
 # initialize OW build environment variables
 - . travis/setowenv.sh
 # get clone of GitHub repository to return Travis CI OW build/log files
 # and compress GitHub repository if necessary to hold only a few last builds
 - travis/gitget.sh
 - env | sed -n -e '/^TRAVIS/p' -e '/^OW/p' | sort

#script:
# - build.sh rel

after_failure:
 # after failure transfer log files back to GitHub repository
 - travis/gitupdf.sh

after_success:
 # after success transfer OW build to GitHub repository
 - travis/gitupds.sh

jobs:
  include:
    - stage: Bootstrap Linux
      os: linux
      install:
        - export OWTRAVISJOB=BOOTLINUX
        # initialize OW build tools
        - travis/initools.sh
      script:
        - travis/build.sh boot
      before_cache:
        # upload OW build tools
        - travis/savtools.sh
    - stage: Build Linux
      os: linux
      install:
        - export OWTRAVISJOB=BUILDLINUX
        - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then export BUILDER_OPT=-q; fi
        # download OW build tools
        - travis/rsttools.sh
      script:
        - travis/build.sh rel
    - stage: Build PDF documentation
      os: linux
      install:
        - export OWTRAVISJOB=PDFDOCLINUX
        # download OW build tools
        - travis/rsttools.sh
      script:
        - travis/build.sh docpdf
    - stage: Bootstrap OSX
      os: osx
      install:
        - export OWTRAVISJOB=BOOTOSX
        # initialize OW build tools
        - travis/initools.sh
      script:
        - travis/build.sh boot
      before_cache:
        # upload OW build tools
        - travis/savtools.sh
#    - stage: Build OSX
#      os: osx
#      install:
#        - export OWTRAVISJOB=BUILDOSX
#        - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then export BUILDER_OPT=-q; fi
#        # install DOS Emulator
#        - brew install dosbox
#        - export OWDOSBOX=dosbox
#        # install Ghostscript
#        - brew install ghostscript
#        # download OW build tools
#        - travis/rsttools.sh
#      script:
#        - travis/build.sh rel
    - stage: Clear cache
      os: linux
      install:
        - export OWTRAVISJOB=CLEARCACHE
      before_script: true
      script:
        - travis/initools.sh

#addons:
#  coverity_scan:
#    project:
#      name: "open-watcom/open-watcom-v2"
#      description: "Build submitted via Travis CI"

#    notification_email:    malak.jiri@gmail.com
#    build_command_prepend:
#    build_command:         $OWROOT/build.sh
#    branch_pattern:        master
